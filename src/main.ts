import 'reflect-metadata'
import './integrations/config'
import { app, port, lokiHost } from './app'
import logger from './integrations/logger'

import { AppDataSource } from './integrations/data-source'
//todo: Add CI/CD
//todo: unit, integ, e2e
async function bootstrap() {
  try {
    app.listen(port, () => {
      logger.info(`Listening port is ${port}`)
    })
    await AppDataSource.initialize()
    logger.info('Database initialized')

    const res = await fetch(`${lokiHost}/ready`)
    if (res.ok) {
      logger.info('Grafana-Loki initialized %o', res)
    } else {
      logger.error('Failed to initialize Grafana-Loki')
      throw new Error('Failed to initialize Grafana-Loki')
    }
  } catch (err) {
    logger.error('Failed to initialize:', err)
    process.exit(1)
  }
}

bootstrap()
/*–Ø –∏–∑—É—á–∏–ª –≤–∞—à –ø—Ä–æ–µ–∫—Ç. –£ –≤–∞—Å –∑–∞–ª–æ–∂–µ–Ω–∞ –æ—Ç–ª–∏—á–Ω–∞—è, —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –æ—Å–Ω–æ–≤–∞:

–ß–µ—Ç–∫–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã, –°–µ—Ä–≤–∏—Å—ã –∏ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ (Controller-Service-Repository) ‚Äî —ç—Ç–æ –æ—Ç–ª–∏—á–Ω–æ.

–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å—Ç–µ–∫: TypeScript, Express 5, TypeORM –∏ Zod –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ ‚Äî –ø—Ä–µ–∫—Ä–∞—Å–Ω—ã–π –≤—ã–±–æ—Ä.

–û–∫—Ä—É–∂–µ–Ω–∏–µ: –ù–∞–ª–∏—á–∏–µ Docker, docker-compose –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å Loki/Grafana –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Å–µ—Ä—å–µ–∑–Ω—ã–π –ø–æ–¥—Ö–æ–¥.

–ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ JSend-–ø–æ–¥–æ–±–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ (, AppError) –∏ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ ‚Äî —ç—Ç–æ best practice.

–í–æ—Ç —á—Ç–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å, –∫–∞–∫–∏–µ best practices –≤–Ω–µ–¥—Ä–∏—Ç—å –∏ –∫–∞–∫–∏–µ —Ñ–∏—á–∏ –¥–æ–±–∞–≤–∏—Ç—å.

üöÄ Best Practice –∫ –≤–Ω–µ–¥—Ä–µ–Ω–∏—é
1. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (–ö—Ä–∏—Ç–∏—á–Ω–æ!)
–•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π: –í—ã —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç–µ –ø–∞—Ä–æ–ª—å –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ (userRepository.save(user)). –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —É—è–∑–≤–∏–º–æ—Å—Ç—å. –ü–∞—Ä–æ–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Ö–µ—à–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º.

–†–µ—à–µ–Ω–∏–µ: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–∏–±–ª–∏–æ—Ç–µ–∫—É bcrypt.

–î–æ–±–∞–≤—å—Ç–µ bcrypt –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (npm i bcrypt –∏ npm i -D @types/bcrypt).

–ü–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ UserService –∏–ª–∏ UserRepository, —Ö–µ—à–∏—Ä—É–π—Ç–µ –ø–∞—Ä–æ–ª—å:

TypeScript

// ...
const salt = await bcrypt.genSalt(10)
const hashedPassword = await bcrypt.hash(user.password, salt)
user.password = hashedPassword
return await userRepository.save(user)
// ...
–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å Docker: –í Dockerfile –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –æ—Ç root –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –°–æ–∑–¥–∞–π—Ç–µ –∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏ (USER node) –≤ runner —Å—Ç–µ–π–¥–∂–µ.

2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
–£–ø—Ä–æ—â–µ–Ω–∏–µ errorHandler.ts: –í–∞—à errorHandler –∏–º–µ–µ—Ç if –¥–ª—è –∫–∞–∂–¥–æ–≥–æ err.code. –≠—Ç–æ —Å—Ç–∞–Ω–µ—Ç —Å–ª–æ–∂–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å. –í—ã —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ AppError, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–¥–µ—Ä–∂–∏—Ç statusCode.

–†–µ—à–µ–Ω–∏–µ: –°–¥–µ–ª–∞–π—Ç–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –±–æ–ª–µ–µ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–º:

TypeScript

// ...
if (err instanceof AppError) {
  logger.warn(err.message, { code: err.code, data: err.message }); // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É 'fail'
  return res.status(err.statusCode).json(
    new ErrorResponse({
      code: err.code,
      name: err.name, // 'Validation Error', 'Duplicate Data' etc.
      message: err.message,
    })
  );
}

// –î–ª—è –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö, –Ω–µ-AppError –æ—à–∏–±–æ–∫
logger.error('Unhandled Error', err); // –õ–æ–≥–∏—Ä—É–µ–º –∫–∞–∫ –Ω–∞—Å—Ç–æ—è—â—É—é –æ—à–∏–±–∫—É
return res.status(500).json(
  new ErrorResponse({
    code: ErrorCodes.UNKNOWN_ERROR,
    name: 'Unknown Error',
    message: 'An unexpected error occurred',
  })
);
// ...
–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫: –ó–∞–º–µ–Ω–∏—Ç–µ console.log –≤ errorHandler.ts –Ω–∞ logger.error –∏–ª–∏ logger.warn, —á—Ç–æ–±—ã –æ—à–∏–±–∫–∏ –ø–æ–ø–∞–¥–∞–ª–∏ –≤ Loki.

3. –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å (Consistency)
Async/Await –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞—Ö: –í EmployController.ts –º–µ—Ç–æ–¥ getAllEmployees –Ω–µ —è–≤–ª—è–µ—Ç—Å—è async –∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç await –ø—Ä–∏ –≤—ã–∑–æ–≤–µ —Å–µ—Ä–≤–∏—Å–∞. –≠—Ç–æ –±–∞–≥: empl –±—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å Promise, –∞ –Ω–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç.

–†–µ—à–µ–Ω–∏–µ: –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ async –∏ await –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π.

TypeScript

// EmployController.ts
static getAllEmployees = async (req: Request, res: Response, next: NextFunction) => { // –î–æ–±–∞–≤–∏—Ç—å async –∏ next
  try {
    const empl = await EmployeeService.getAllEmployees() // –î–æ–±–∞–≤–∏—Ç—å await
    res.json(new SuccessResponse(empl)) // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SuccessResponse
  } catch (err) {
    next(err) // –ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å –æ—à–∏–±–∫–∏ –≤ errorHandler
  }
}
–°—Ç–∏–ª—å —ç–∫—Å–ø–æ—Ä—Ç–∞: –í—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ export class UserService –∏ export default EmployeeService. –í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω —Å—Ç–∏–ª—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, export class ... —Å–æ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ –º–µ—Ç–æ–¥–∞–º–∏) –∏ –ø—Ä–∏–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ—Å—å –µ–≥–æ –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤, —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤ –∏ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤.

4. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–ü–æ—Ä—Ç –≤ Docker: –í–∞—à Dockerfile –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø–æ—Ä—Ç EXPOSE 8080, –Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, —Å—É–¥—è –ø–æ config.ts –∏ .env.local, —Å–ª—É—à–∞–µ—Ç –ø–æ—Ä—Ç 3002.

–†–µ—à–µ–Ω–∏–µ: –ü—Ä–∏–≤–µ–¥–∏—Ç–µ –∫ –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏—é. –õ–∏–±–æ –∏–∑–º–µ–Ω–∏—Ç–µ EXPOSE –≤ Dockerfile –Ω–∞ 3002, –ª–∏–±–æ (–ª—É—á—à–µ) —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ ENV PORT=8080 –≤ Dockerfile –∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ EXPOSE $PORT.

üõ†Ô∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ —É–ª—É—á—à–µ–Ω–∏—è
–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–∏–∑ –≤–∞—à–µ–≥–æ TODO):

Unit-—Ç–µ—Å—Ç—ã: –ù–∞—á–Ω–∏—Ç–µ —Å UserService (—Å –º–æ–∫–æ–º UserRepository) –∏ —Å—Ö–µ–º zod. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ jest –∏–ª–∏ vitest.

Integration-—Ç–µ—Å—Ç—ã: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∑–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ —Å –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç–µ—Å—Ç–æ–≤–æ–π –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä—è—Ç—å –≤—Å—é —Å–≤—è–∑–∫—É –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä -> –°–µ—Ä–≤–∏—Å -> –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π -> –ë–î.

E2E-—Ç–µ—Å—Ç—ã: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ supertest –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è API "—Å–Ω–∞—Ä—É–∂–∏".

CI/CD (–∏–∑ –≤–∞—à–µ–≥–æ TODO):

–ù–∞—Å—Ç—Ä–æ–π—Ç–µ GitHub Actions –∏–ª–∏ GitLab CI.

–°–æ–∑–¥–∞–π—Ç–µ –ø–∞–π–ø–ª–∞–π–Ω: Lint -> Test -> Build -> Push Docker Image.

–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤:

–î–æ–±–∞–≤—å—Ç–µ middleware –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö –≤—Ö–æ–¥—è—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, morgan –∏–ª–∏ –∫–∞—Å—Ç–æ–º–Ω—ã–π middleware —Å winston). –≠—Ç–æ –æ—á–µ–Ω—å –ø–æ–º–æ–≥–∞–µ—Ç –≤ –æ—Ç–ª–∞–¥–∫–µ.

Graceful Shutdown:

–í main.ts –¥–æ–±–∞–≤—å—Ç–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ SIGTERM –∏ SIGINT, —á—Ç–æ–±—ã –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ —Å–µ—Ä–≤–µ—Ä–∞ (–æ—Å–æ–±–µ–Ω–Ω–æ –≤ Docker) –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–Ω–∞—á–∞–ª–∞ –∑–∞–∫—Ä—ã–≤–∞–ª–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ë–î (AppDataSource.destroy()), –∞ –ø–æ—Ç–æ–º –∑–∞–≤–µ—Ä—à–∞–ª–æ –ø—Ä–æ—Ü–µ—Å—Å. –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç –ø–æ—Ç–µ—Ä—é –¥–∞–Ω–Ω—ã—Ö –∏ –æ—à–∏–±–∫–∏.

‚ú® –ù–æ–≤—ã–µ —Ñ–∏—á–∏ (–ß—Ç–æ –¥–æ–±–∞–≤–∏—Ç—å)
–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (–°–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ):

–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è: –í–∞—à sighIn (–≤–µ—Ä–æ—è—Ç–Ω–æ, signUp - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è) —Å–æ–∑–¥–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –í–∞–º –Ω—É–∂–Ω–∞ Login (–≤—Ö–æ–¥) –∫–æ–Ω–µ—á–Ω–∞—è —Ç–æ—á–∫–∞.

–°–æ–∑–¥–∞–π—Ç–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç /users/login.

–û–Ω –¥–æ–ª–∂–µ–Ω –ø—Ä–∏–Ω–∏–º–∞—Ç—å email –∏ password.

–ù–∞—Ö–æ–¥–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ email –∏ —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å —Ö–µ—à –ø–∞—Ä–æ–ª—è —Å –ø–æ–º–æ—â—å—é bcrypt.compare().

–í —Å–ª—É—á–∞–µ —É—Å–ø–µ—Ö–∞, –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å JWT (JSON Web Token) –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –µ–≥–æ –∫–ª–∏–µ–Ω—Ç—É.

–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è:

–°–æ–∑–¥–∞–π—Ç–µ middleware (authMiddleware), –∫–æ—Ç–æ—Ä–æ–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç JWT –≤ Authorization –∑–∞–≥–æ–ª–æ–≤–∫–µ.

–ó–∞—â–∏—Ç–∏—Ç–µ —ç—Ç–∏–º middleware —Ä–æ—É—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, getAllUsers).

RBAC (Role-Based Access Control):

–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –ø–æ–ª–µ role –≤ User.

authMiddleware –º–æ–∂–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å req.user (—Å id –∏ role) –≤ –∑–∞–ø—Ä–æ—Å.

–°–æ–∑–¥–∞–π—Ç–µ –≤—Ç–æ—Ä–æ–µ middleware checkRole(['Admin']), –∫–æ—Ç–æ—Ä–æ–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç req.user.role –∏ –∑–∞–ø—Ä–µ—â–∞–µ—Ç –¥–æ—Å—Ç—É–ø, –µ—Å–ª–∏ —Ä–æ–ª—å –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç.

–ü—Ä–∏–º–µ–Ω–∏—Ç–µ –µ–≥–æ –∫ —ç–Ω–¥–ø–æ–∏–Ω—Ç—É getAllUsers.

–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API:

–ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–π—Ç–µ swagger-ui-express –∏ tsoa –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ OpenAPI 3.0 —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é. zod –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —á–∞—Å—Ç–∏ —Å—Ö–µ–º—ã Swagger, —á—Ç–æ —Å—ç–∫–æ–Ω–æ–º–∏—Ç –≤—Ä–µ–º—è.

Health Check:

–°–æ–∑–¥–∞–π—Ç–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç /health (GET).

–û–Ω –¥–æ–ª–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å 200 OK, –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç, –∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –ø—Ä–æ–≤–µ—Ä—è—Ç—å, —á—Ç–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ë–î (AppDataSource.isInitialized) –∞–∫—Ç–∏–≤–Ω–æ. –≠—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç –¥–ª—è docker-compose healthcheck –∏ Kubernetes.

–ü–æ–ª–Ω—ã–π CRUD –¥–ª—è Employee:

–°–µ–π—á–∞—Å —É –≤–∞—Å –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ –∑–∞–≥–ª—É—à–∫–∞ getAllEmployees.

–°–æ–∑–¥–∞–π—Ç–µ Employee entity, —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π, —Å–µ—Ä–≤–∏—Å –∏ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã –¥–ª—è –≤—Å–µ—Ö CRUD-–æ–ø–µ—Ä–∞—Ü–∏–π (Create, Read, Update, Delete) —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π Zod, –∫–∞–∫ –≤—ã —Å–¥–µ–ª–∞–ª–∏ –¥–ª—è User.*/
